<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Index</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <!--
    <div class="fromDB" id=titleDiv align=center></div>

  <div class="fromDB" id=headDiv align=center></div>
-->

  <div class="fromDB">
    <div class="fields" id="fields" hidden></div>
  </div>


  <!--
  <div class="fromDB" id=footDiv align=center></div>

  <div class="fromDB" id=notes align=left></div>
-->

      
      <!--    sign-in Form     -->
      <form id='sign-in-form' hidden>
          <div id="inputs" >   
          <input type="email" id="email2" name="email" placeholder="your@email.com"><br>
          <input type="password" name="Yourpass" id="pass" placeholder="password"><br>
          <button type="button" onclick="findInputSignInAuth()">Sign in</button>
          </div>
        </form>

  <!--    sign-up Form     -->
  <form id='sign-up-form' hidden>
  <div id="inputs" >
      <input type="email" id="email" placeholder="your@email.com"><br>
      <input type="password" id="pass-up" placeholder="password"><br>
      <input type="text" id="userName" placeholder="User Name - optional"><br>
      <button type="button" onclick="findInputSendAuthWriteDb()">New user account sign up</button><br>
    </div>
  </form>



<div id="inputs" > <!-- Buttons which change depending on null user or signed in user-->

  <hr> 
  <p> 
    <!--     Changed from calling a webpage to loading the functions     -->  
    <button id='FCMtoken' type=button onclick="FCMtoken()" hidden>Click to receive notifications or update permission</a></button>
<!--
    <button id='FCMtoken' type=button onclick="location.href='messaging.html' " hidden>Click to permit notifications</a></button>
-->
  </p> 

  <button id='signup' type=button onclick="location.href='sign-up-db-combo.html' "  hidden>Sign up   -   (Auth & db)</a>
  <button id='signin' type="button" onclick="location.href='sign-in.html'" hidden>Sign in</button>
        <hr>
        <!--
        <button id='seeuser' type="button" onclick="location.href='db-read-one-user-doc.html'">See user account</button>
        -->
  <button id='signout' type="button" onclick="findInputSignOutAuth()" hidden>Sign out</button>
  <button id='delete' type="button" onclick="deleteAccount()" hidden>Delete account <i>(at auth & users</i>)</button>
        <hr>
        <!--        
        <button id='check' type="button" onclick="checkUser()">Check if logged in</button>
        <button id='userid' type="button" onclick="isValidUser()">Find user Auth ID</button>
        -->
        <hr>  
  <button id='sendmessage' type="button" onclick="location.href='messageInput.html' " hidden>Send Message <i>(Creators)</i></button>
   <hr>
  <button id='index' type=button onclick="location.href='developer-index.html' " hidden>[Developer index]</a>
      </div>






<!--            load Scripts           -->

  <script src="https://www.gstatic.com/firebasejs/5.8.4/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.8.6/firebase-messaging.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.8.5/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.8.4/firebase-firestore.js"></script>
  
  
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyDe4TVROJcbVJfSZ5WkTZdfK7bWXlnx18Q",
      authDomain: "jogthem.firebaseapp.com",
      databaseURL: "https://jogthem.firebaseio.com",
      projectId: "jogthem",
      storageBucket: "jogthem.appspot.com",
      messagingSenderId: "593287500713"
    };
    firebase.initializeApp(config);
  </script>

<script src="get-FCMtoken.js"></script>

  <script>
     var c = "users"; // to be able to read from other collections and title them change var c
     var db = firebase.firestore();
       
        var userCreator;

    firebase.auth().onAuthStateChanged(function (user) {  
      if (user) {
        // User is signed in.

        console.log('user is signed in.', user.email, " ", user.uid );
 var userId = user.uid;


        db.collection(c).doc(userId).get()
          .then(function (doc) {

            userCreator = doc.data().creator;
            console.log('userCreator= ',userCreator);//works

        displayDoc(doc);
           showSignOutDelete();  
          })
          .catch(function (error) {
            console.error("Error getting or displaying: ", error);
          });

      } else {
        // No user is signed in.
        console.log('No user is signed in.');
        showSignUpSignIn();
 
      }
    });
  </script>

  <script>
    function displayDoc(doc) {
      console.log(doc.id, "=>", doc.data());

      //displayAdminParts(doc) //don't display admin part to users
      displayUserPart(doc); //users would only see this part normally

    }
/*
    function displayAdminParts(doc){

      document.getElementById("titleDiv").innerHTML = "<font color ='blue'> Reading from database collection <br> <h1><b>" + c + "</b></h1></font>"; //adding name of collection to title
      document.getElementById("notes").innerHTML = "<font size=-2><i>Document fields are</i><br><b>doc.id:</b> This is your auth() unique ID also used in the user database<br><b>email:</b> used for sign-up and sign-in<br><b>userName:</b> Optional<br><b>admin</b>: for those who can alter the database entries<br><b>creator:</b> allows you to send messages<br><b>fan:</b> allows you to receive messages<br><b>FCMtoken:</b> a code that identifies your device for receiving messages<br></font> ";
      document.getElementById("headDiv").innerHTML = "<font color ='green'>doc.id: </font><hr>" + doc.id + "<p><hr></p>";
      document.getElementById("footDiv").style.wordWrap = 'break-word';//FCMTokens are long strings
      document.getElementById("footDiv").innerHTML = "<font color ='darkblue'>FCMtoken:<hr></font> " + doc.data().FCMtoken + "<hr><p></p>";
      //Firebase Messaging Token not show to user
    }
*/
    function displayUserPart(doc){ //each time there is a state change the doc is displayed again
console.log('Inside dsiplay user part');
      document.getElementById("fields").style.wordWrap = 'break-word'; //for small screens
      document.getElementById("fields").innerHTML = "<p> email:<font color = 'white'> <b>" + doc.data().email + "</b></font></p>";
      document.getElementById("fields").innerHTML += "userName: <b>" + doc.data().userName + "</b><p></p>";
      document.getElementById("fields").innerHTML += " [<i>  fan: </i>" + doc.data().fan + " ] <p></p>";      
      document.getElementById("fields").innerHTML += " [<i>  creator:</i> " + doc.data().creator + " ] ";
      document.getElementById("fields").innerHTML += " [<i>  admin: </i>" + doc.data().admin + " ]<br>";
    }


//             Sign up    or Sign in            //
    
    function showSignUpSignIn(){
console.log('Show sign up and sign in forms');
console.log('Hides [sign out]  [delete account] [user Account]');

document.getElementById("signout").style.display="none";
document.getElementById("delete").style.display="none";
//document.getElementById("seeuser").style.display="none"; 
document.getElementById("sendmessage").style.display="none";
document.getElementById("FCMtoken").style.display="none";

document.getElementById("fields").style.display="none"; //If no user, the place where data is displayed is off(but data of user still there if just signed out)

document.getElementById("signin").style.display="none"; //no button as form is displayed
document.getElementById("sign-in-form").style.display="block";

document.getElementById("signup").style.display="none";  
document.getElementById("sign-up-form").style.display="block";



         //    Show sign up            OR            sign in
}

function showSignOutDelete(){
  console.log('Show sign out, delete account, send message, get token, UserAccount');
  console.log('Hides [sign in] and [sign up] ');

document.getElementById("signout").style.display="block";
document.getElementById("delete").style.display="block";
//document.getElementById("seeuser").style.display="block";

if (userCreator) {  //Only allow message to be sent by creators 
  console.log('userCreator= ', userCreator)
  document.getElementById("sendmessage").style.display="block";
}
else console.log('Not a creator', userCreator); //="start value"

document.getElementById("FCMtoken").style.display="block";
document.getElementById("fields").style.display="block"; //show user details

document.getElementById("signin").style.display="none";
document.getElementById("signup").style.display="none";
document.getElementById("sign-in-form").style.display="none"; 
document.getElementById("sign-up-form").style.display="none";


}

  </script>

<script> 


function FCMtoken(){
  console.log('inside FCMtoken');
  getFCMtokenSendToServerAskPermission();
      document.getElementById("FCMtoken").style.display="none";
      //prevent repeat click of this button- after first click there is an uncaught error
      // of use public key before get token. If refresh, then works for first click again
}


function deleteAccount() {
      var status = "not yet deleted";
      var user_uid;
      console.log("Inside deleteAccount user=", user, "status=",status); //status is to prevnt the authState command being active after a delete and new state change
      //var email_id = "startValue";
      firebase.auth().onAuthStateChanged((user) => {  //this is being triggered when someone signs-up
        if (user && status == "not yet deleted" ) {
          user_uid = user.uid; email_id = user.email;
          console.log("onAuthStateChange says user id=", user_uid, email_id)
          //document.getElementById("Display1").innerHTML = "<i>Valid user uid:</i> "+ user_uid + "<p></p><i> Email= </i>" +email_id ;
          //return(user_uid); //new idea -seems to fail


          if (confirm("Script running to delete this user document: " + user_uid)) {
            var db = firebase.firestore();
            db.collection('users').doc(user_uid).delete().then(function () {
              console.log("Document successfully deleted from users!");//this lies. says okay even when there wasn't a document

              // the auth delete does not work
              var user = firebase.auth().currentUser;
              console.log('Called current user.uid', user_uid);

              user.delete().then(function () {
                //user deleted?
                status = "deleted";
                console.log('User deleted?', user, user_uid);

              }).catch(function (error) {
                //error
                console.log('error in deletion', error);
              });


            }).catch(function (error) {
              console.error("Error removing document: ", error); //does this work? I don't think so
            });
          }
        }
        else { //alert('No one is logged in. To delete account first log in'); //very strange repeated
          console.log("deleteUser() says status =", status);//why is this running when user deleted???
          //document.getElementById("Display1").innerHTML = "User id undefined";
        }
      })
    }  

        function findInputSignOutAuth() {
          //  window.alert("Here test");
          var user = firebase.auth().currentUser;
          if (user != null) {
          //  var email_id = user.email;
           // document.getElementById("Display1").innerHTML = "<i>Email logging out:</i> " + email_id + '<button type="button" onclick="findInputSendAuth()">LogOut</button>';
    
            firebase.auth().signOut();
          }
          else {
           // document.getElementById("Display1").innerHTML = "User NULL therefore has already logged out";
          }
        }
        
      </script>

<script>
        function findInputSignInAuth() {
          var Email, pass, errorMess;
          Email = document.getElementById("email2").value;
          pass = document.getElementById("pass").value;
    
//          document.getElementById("Display1").innerHTML += "<i>Email:</i> " + Email + "<i> Password:</i> " + pass;
    
          firebase.auth().signInWithEmailAndPassword(Email, pass).catch(function (error) {
            // Handle Errors here.
            var errorCode = error.code;
            var errorMessage = error.message;
            if (errorCode == 'auth/weak-password') {
              alert('The password is too weak.');
            } else {
              alert(errorMessage);
            }
            //document.getElementById("Display2").innerHTML += " " + errorMessage + " ";
            console.log(error);
          });
        }
      </script>


<script>
    var user = "start value"; //

    function findInputSendAuthWriteDb() {
      //read inputs from sign-up form
      var email, pass, userName;
      email = document.getElementById("email").value;
      pass = document.getElementById("pass-up").value;
      userName = document.getElementById("userName").value;

      console.log(email + " " + pass + " " + userName);

      //send info to authentication, and then to database with same user id

      firebase.auth().createUserWithEmailAndPassword(email, pass).catch(function (error) {
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        if (errorCode == 'auth/weak-password') {
          alert('The password is too weak.');
        } else {
          alert(errorMessage);
        }
        console.log(error);
      }).then(cred => { 

        if(cred) { //comes here even if input failed and auth not done. So checking if valid
        console.log('Auth completed', cred); //works

        // Values to be written into the database document
        var userId = cred.user.uid, admin = false, creator = false, fan = true, FCMtoken = "";

        var db = firebase.firestore();
        return db.collection('users').doc(cred.user.uid).set({

          FCMtoken: FCMtoken, //placeholder for later messaging system
          admin: admin,       //this may be used later, if system uses web administration
          creator: creator, //this may be used later, if system supports more than 1 creator
          email: email,
          fan: fan, //most users will be classified as fans. If other need to overwrite or use different sign-up
          userName: userName // Goes on DB, could also go into auth?

        }).then(function () {
          console.log("Document written with ID: ", userId); //works
        }).catch(function (error) {
          // Handle Errors here.        
          console.log(error);
        });
        console.log('write to db no errors'); //doesn't happen???
      }
      });
    }
  </script>
</body>
</html>
